#!/usr/bin/env bash

set -euo pipefail

function check_formatting() {
    if uv run ruff format --check . > /dev/null 2>&1; then
        echo "âœ“ Formatting check passed"
    else
        echo "âœ— Formatting check failed. Run 'ruff format .' to fix."
        echo ""
        echo "Detailed output:"
        uv run ruff format --check .
        exit 1
    fi
}

function check_linting() {
    if uv run ruff check . > /dev/null 2>&1; then
        echo "âœ“ Linting check passed"
    else
        echo "âœ— Linting check failed. Run 'ruff check --fix .' to auto-fix some issues."
        echo ""
        echo "Detailed output:"
        uv run ruff check .
        exit 1
    fi
}

function check_types() {
    if uv run mypy src/ > /dev/null 2>&1; then
        echo "âœ“ Type checking passed"
    else
        echo "âœ— Type checking failed"
        echo ""
        echo "Detailed output:"
        uv run mypy src/
        exit 1
    fi
}

function main() {
    # Find git root and change to it
    root=$(git rev-parse --show-toplevel 2>/dev/null)
    if [ -z "$root" ]; then
        echo "âœ— Error: Not in a git repository"
        exit 1
    fi
    cd "$root" || exit 1

    # Check if uv is available
    if ! command -v uv &> /dev/null; then
        echo "âœ— Error: uv is not installed or not in PATH"
        exit 1
    fi

    check_formatting
    check_linting
    check_types

    echo "ðŸŽ‰ All linting checks passed!"
    exit 0
}

main